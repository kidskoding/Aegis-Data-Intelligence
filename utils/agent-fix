#!/usr/bin/env bash
set -euo pipefail

# ─── Colors ───────────────────────────────────────────────────────────────────
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m'

info()  { echo -e "${BLUE}[INFO]${NC}  $*"; }
ok()    { echo -e "${GREEN}[OK]${NC}    $*"; }
warn()  { echo -e "${YELLOW}[WARN]${NC}  $*"; }
err()   { echo -e "${RED}[ERR]${NC}   $*" >&2; }
step()  { echo -e "\n${BOLD}── Step $1: $2 ──${NC}"; }

# ─── Usage ────────────────────────────────────────────────────────────────────
usage() {
  cat <<EOF
Usage: agent-fix <issue-number> [options]

Options:
  --test-cmd CMD    Override test command
  --base BRANCH     Base branch (default: main)
  --dry-run         Skip push, PR creation, and merge
  --max-turns N     Max Claude agent turns (default: 25)
  -h, --help        Show this help

Config:
  Place a .agent-fix.conf in your repo root with key=value pairs:
    TEST_CMD=cd backend && pytest tests/ -v
    BASE_BRANCH=main
EOF
  exit 0
}

# ─── Defaults ─────────────────────────────────────────────────────────────────
ISSUE_NUM=""
TEST_CMD=""
BASE_BRANCH="main"
DRY_RUN=false
MAX_TURNS=25
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# ─── Load config file ────────────────────────────────────────────────────────
load_config() {
  local conf="$REPO_ROOT/.agent-fix.conf"
  if [[ -f "$conf" ]]; then
    info "Loading config from $conf"
    while IFS='=' read -r key value; do
      [[ -z "$key" || "$key" == \#* ]] && continue
      case "$key" in
        TEST_CMD)     [[ -z "$TEST_CMD" ]]     && TEST_CMD="$value" ;;
        BASE_BRANCH)  [[ "$BASE_BRANCH" == "main" ]] && BASE_BRANCH="$value" ;;
      esac
    done < "$conf"
  fi
}

# ─── Parse arguments ─────────────────────────────────────────────────────────
parse_args() {
  while [[ $# -gt 0 ]]; do
    case "$1" in
      -h|--help)     usage ;;
      --test-cmd)    TEST_CMD="$2"; shift 2 ;;
      --base)        BASE_BRANCH="$2"; shift 2 ;;
      --dry-run)     DRY_RUN=true; shift ;;
      --max-turns)   MAX_TURNS="$2"; shift 2 ;;
      -*)            err "Unknown option: $1"; usage ;;
      *)
        if [[ -z "$ISSUE_NUM" ]]; then
          ISSUE_NUM="$1"; shift
        else
          err "Unexpected argument: $1"; usage
        fi
        ;;
    esac
  done

  if [[ -z "$ISSUE_NUM" ]]; then
    err "Issue number is required"
    usage
  fi

  if ! [[ "$ISSUE_NUM" =~ ^[0-9]+$ ]]; then
    err "Issue number must be a positive integer, got: $ISSUE_NUM"
    exit 1
  fi
}

# ─── Prerequisite checks ─────────────────────────────────────────────────────
check_prereqs() {
  local missing=0

  if ! command -v gh &>/dev/null; then
    err "gh CLI not found. Install: https://cli.github.com"
    missing=1
  elif ! gh auth status &>/dev/null; then
    err "gh CLI not authenticated. Run: gh auth login"
    missing=1
  fi

  if ! command -v claude &>/dev/null; then
    err "claude CLI not found. Install: https://docs.anthropic.com/en/docs/claude-code"
    missing=1
  fi

  if ! command -v git &>/dev/null; then
    err "git not found"
    missing=1
  fi

  if [[ -n "$(git -C "$REPO_ROOT" status --porcelain)" ]]; then
    err "Working tree is not clean. Commit or stash changes first."
    missing=1
  fi

  [[ $missing -ne 0 ]] && exit 1
  ok "All prerequisites met"
}

# ─── Main (placeholder — filled in by subsequent tasks) ──────────────────────
main() {
  parse_args "$@"
  load_config
  check_prereqs
  info "Ready to fix issue #$ISSUE_NUM (base: $BASE_BRANCH, dry-run: $DRY_RUN)"
}

main "$@"
