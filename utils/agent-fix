#!/usr/bin/env bash
set -euo pipefail

# ─── Colors ───────────────────────────────────────────────────────────────────
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m'

info()  { echo -e "${BLUE}[INFO]${NC}  $*"; }
ok()    { echo -e "${GREEN}[OK]${NC}    $*"; }
warn()  { echo -e "${YELLOW}[WARN]${NC}  $*"; }
err()   { echo -e "${RED}[ERR]${NC}   $*" >&2; }
step()  { echo -e "\n${BOLD}── Step $1: $2 ──${NC}"; }

# ─── Usage ────────────────────────────────────────────────────────────────────
usage() {
  cat <<EOF
Usage: agent-fix <issue-number> [options]

Options:
  --test-cmd CMD    Override test command
  --base BRANCH     Base branch (default: main)
  --dry-run         Skip push, PR creation, and merge
  --max-turns N     Max Claude agent turns (default: 25)
  -h, --help        Show this help

Config:
  Place a .agent-fix.conf in your repo root with key=value pairs:
    TEST_CMD=cd backend && pytest tests/ -v
    BASE_BRANCH=main
EOF
  exit 0
}

# ─── Defaults ─────────────────────────────────────────────────────────────────
ISSUE_NUM=""
TEST_CMD=""
BASE_BRANCH="main"
DRY_RUN=false
MAX_TURNS=25
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# ─── Load config file ────────────────────────────────────────────────────────
load_config() {
  local conf="$REPO_ROOT/.agent-fix.conf"
  if [[ -f "$conf" ]]; then
    info "Loading config from $conf"
    while IFS='=' read -r key value; do
      [[ -z "$key" || "$key" == \#* ]] && continue
      case "$key" in
        TEST_CMD)     [[ -z "$TEST_CMD" ]]     && TEST_CMD="$value" ;;
        BASE_BRANCH)  [[ "$BASE_BRANCH" == "main" ]] && BASE_BRANCH="$value" ;;
      esac
    done < "$conf"
  fi
}

# ─── Parse arguments ─────────────────────────────────────────────────────────
parse_args() {
  while [[ $# -gt 0 ]]; do
    case "$1" in
      -h|--help)     usage ;;
      --test-cmd)    TEST_CMD="$2"; shift 2 ;;
      --base)        BASE_BRANCH="$2"; shift 2 ;;
      --dry-run)     DRY_RUN=true; shift ;;
      --max-turns)   MAX_TURNS="$2"; shift 2 ;;
      -*)            err "Unknown option: $1"; usage ;;
      *)
        if [[ -z "$ISSUE_NUM" ]]; then
          ISSUE_NUM="$1"; shift
        else
          err "Unexpected argument: $1"; usage
        fi
        ;;
    esac
  done

  if [[ -z "$ISSUE_NUM" ]]; then
    err "Issue number is required"
    usage
  fi

  if ! [[ "$ISSUE_NUM" =~ ^[0-9]+$ ]]; then
    err "Issue number must be a positive integer, got: $ISSUE_NUM"
    exit 1
  fi
}

# ─── Prerequisite checks ─────────────────────────────────────────────────────
check_prereqs() {
  local missing=0

  if ! command -v gh &>/dev/null; then
    err "gh CLI not found. Install: https://cli.github.com"
    missing=1
  elif ! gh auth status &>/dev/null; then
    err "gh CLI not authenticated. Run: gh auth login"
    missing=1
  fi

  if ! command -v claude &>/dev/null; then
    err "claude CLI not found. Install: https://docs.anthropic.com/en/docs/claude-code"
    missing=1
  fi

  if ! command -v git &>/dev/null; then
    err "git not found"
    missing=1
  fi

  if [[ -n "$(git -C "$REPO_ROOT" status --porcelain)" ]]; then
    err "Working tree is not clean. Commit or stash changes first."
    missing=1
  fi

  [[ $missing -ne 0 ]] && exit 1
  ok "All prerequisites met"
}

# ─── Step 1: Fetch issue ─────────────────────────────────────────────────────
fetch_issue() {
  step 1 "Fetching issue #$ISSUE_NUM"

  local issue_json
  issue_json=$(gh issue view "$ISSUE_NUM" --repo "$(gh repo view --json nameWithOwner -q .nameWithOwner)" --json title,body,labels 2>&1) || {
    err "Failed to fetch issue #$ISSUE_NUM. Does it exist?"
    exit 1
  }

  ISSUE_TITLE=$(echo "$issue_json" | jq -r '.title')
  ISSUE_BODY=$(echo "$issue_json" | jq -r '.body // ""')
  ISSUE_LABELS=$(echo "$issue_json" | jq -r '[.labels[].name] | join(", ")')

  ok "Issue: $ISSUE_TITLE"
  [[ -n "$ISSUE_LABELS" ]] && info "Labels: $ISSUE_LABELS"
}

# ─── Step 2: Create branch ───────────────────────────────────────────────────
create_branch() {
  step 2 "Creating branch"

  BRANCH_NAME="fix/issue-${ISSUE_NUM}"

  git -C "$REPO_ROOT" checkout "$BASE_BRANCH" --quiet
  git -C "$REPO_ROOT" pull --quiet 2>/dev/null || true

  if git -C "$REPO_ROOT" show-ref --verify --quiet "refs/heads/$BRANCH_NAME"; then
    warn "Branch $BRANCH_NAME already exists. Switching to it."
    git -C "$REPO_ROOT" checkout "$BRANCH_NAME" --quiet
  else
    git -C "$REPO_ROOT" checkout -b "$BRANCH_NAME" --quiet
  fi

  ok "On branch: $BRANCH_NAME"
}

# ─── Step 3: Run Claude Code ─────────────────────────────────────────────────
run_claude() {
  local prompt="$1"
  step 3 "Running Claude Code"

  info "Invoking claude -p with max $MAX_TURNS turns..."

  CLAUDECODE="" claude -p "$prompt" \
    --max-turns "$MAX_TURNS" \
    --allowedTools "Bash,Read,Edit,Write,Glob,Grep" \
    --output-format text \
    --no-session-persistence \
    2>&1 | tee /tmp/agent-fix-claude-output.txt

  local exit_code=${PIPESTATUS[0]}
  if [[ $exit_code -ne 0 ]]; then
    err "Claude exited with code $exit_code"
    return 1
  fi

  ok "Claude completed successfully"
}

build_prompt() {
  cat <<PROMPT
You are fixing a GitHub issue in this repository.

Issue #${ISSUE_NUM}: ${ISSUE_TITLE}

${ISSUE_BODY}

Instructions:
- Read relevant files to understand the codebase before making changes
- Make the minimal fix needed to resolve the issue
- Do not refactor unrelated code
- Follow existing code conventions (check CLAUDE.md if present)
- Do not commit — the caller script handles commits
PROMPT
}

fix_issue() {
  local prompt
  prompt=$(build_prompt)
  run_claude "$prompt" || {
    err "Claude failed to fix the issue. Aborting."
    exit 1
  }
}

# ─── Step 4: Run tests ───────────────────────────────────────────────────────
run_tests() {
  step 4 "Running tests"

  if [[ -z "$TEST_CMD" ]]; then
    warn "No TEST_CMD configured. Skipping tests."
    warn "Set TEST_CMD in .agent-fix.conf or pass --test-cmd"
    return 0
  fi

  info "Running: $TEST_CMD"
  local test_output
  test_output=$(cd "$REPO_ROOT" && eval "$TEST_CMD" 2>&1) && {
    ok "Tests passed"
    return 0
  }

  warn "Tests failed on first attempt. Feeding errors back to Claude for retry..."
  echo "$test_output" | tail -50

  local retry_prompt
  retry_prompt=$(cat <<RETRY
The fix you made for issue #${ISSUE_NUM} caused test failures. Here is the test output:

\`\`\`
$(echo "$test_output" | tail -100)
\`\`\`

Please fix the code so that all tests pass. Do not commit.
RETRY
)

  run_claude "$retry_prompt" || {
    err "Claude retry failed. Leaving branch for manual inspection."
    exit 1
  }

  info "Re-running tests after Claude retry..."
  test_output=$(cd "$REPO_ROOT" && eval "$TEST_CMD" 2>&1) && {
    ok "Tests passed after retry"
    return 0
  }

  err "Tests still failing after retry. Leaving branch $BRANCH_NAME for manual inspection."
  echo "$test_output" | tail -30
  exit 1
}

# ─── Step 5-6: Commit + Push + PR ────────────────────────────────────────────
commit_changes() {
  step 5 "Committing changes"

  cd "$REPO_ROOT"

  if [[ -z "$(git status --porcelain)" ]]; then
    warn "No changes to commit. Claude may not have made any edits."
    exit 1
  fi

  git add -A
  git commit -m "$(cat <<EOF
fix(agent): resolve #${ISSUE_NUM} — ${ISSUE_TITLE}

Automated fix generated by agent-fix using Claude Code.
Closes #${ISSUE_NUM}

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"

  ok "Changes committed"
}

push_and_pr() {
  step 6 "Pushing and creating PR"

  if [[ "$DRY_RUN" == true ]]; then
    warn "Dry run — skipping push and PR creation"
    info "Branch $BRANCH_NAME has committed changes ready for review."
    return 0
  fi

  git -C "$REPO_ROOT" push -u origin "$BRANCH_NAME"

  PR_URL=$(gh pr create \
    --base "$BASE_BRANCH" \
    --head "$BRANCH_NAME" \
    --title "fix: resolve #${ISSUE_NUM} — ${ISSUE_TITLE}" \
    --body "$(cat <<EOF
## Summary

Automated fix for #${ISSUE_NUM} generated by \`agent-fix\` using Claude Code.

## Issue

**${ISSUE_TITLE}**

${ISSUE_BODY}

## Test Results

Tests passed before PR creation (test command: \`${TEST_CMD:-none}\`).

---
Generated with [agent-fix](https://github.com/AgenticAI-UIUC/Lecture-1) + Claude Code
EOF
)")

  ok "PR created: $PR_URL"
}

# ─── Main (placeholder — filled in by subsequent tasks) ──────────────────────
main() {
  parse_args "$@"
  load_config
  check_prereqs

  fetch_issue
  create_branch
  fix_issue
  run_tests
}

main "$@"
