name: Claude Code Agent

on:
  workflow_dispatch:
  issue_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      github.actor == 'ashcastelinocs124' && (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'issues' && contains(github.event.issue.body, '@claude')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude'))
      )
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend dependencies
        run: |
          cd aegis/backend
          pip install -r requirements.txt 2>/dev/null || pip install fastapi uvicorn sqlalchemy aiosqlite pydantic-settings httpx langchain langchain-community langchain-openai networkx

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          trigger_phrase: "@claude"
          claude_args: "--max-turns 50"
          prompt: |
            You are fixing issues and reviewing PRs for the Aegis Data Intelligence platform.

            ## CRITICAL: Do Not Waste Turns
            - The issue/PR context is ALREADY provided to you above. Read it carefully.
            - Do NOT list issues, fetch issues, or call GitHub API to find issues.
            - Do NOT spend turns on exploration — go straight to implementing the fix.
            - Python 3.11 and backend dependencies are already installed.
            - `gh` CLI is authenticated and ready to use.

            ## Mandatory: Run Tests Before Any PR

            After making changes, ALWAYS run the test suite:
            ```bash
            cd aegis/backend && python -m pytest tests/ -v --tb=short
            ```
            ALL tests must pass before creating a PR. If tests fail, fix the issue and re-run.
            Baseline: 68 tests. Your changes should not reduce this count.

            ## Complexity Assessment & PR Behavior

            After implementing the fix and passing tests, assess the change complexity:

            ### SMALL (auto-merge)
            Criteria — ALL of these must be true:
            - 1-2 files changed (excluding test files)
            - Less than 50 lines of code changed
            - Does NOT touch: core/models.py, core/database.py, config.py, main.py, any agent file, any API router
            - Pure bug fix with clear cause (typo, off-by-one, missing null check, import fix)
            - No new dependencies added

            For SMALL changes:
            1. Create a PR with title: `fix: <description>`
            2. Add label `auto-merge` to the PR
            3. Enable auto-merge on the PR: `gh pr merge --auto --squash <pr-number>`
            4. Close the original issue with: `gh issue close <issue-number> -c "Fixed in #<pr-number> (auto-merged — small fix)"`

            ### MEDIUM-TO-CRITICAL (needs review)
            Criteria — ANY of these is true:
            - 3+ files changed
            - 50+ lines of code changed
            - Touches core files (models, database, config, agents, API routers)
            - Adds new dependencies
            - Changes business logic or data flow
            - Modifies the agent pipeline (sentinel, orchestrator, architect, executor, investigator)
            - Affects async/sync bridging patterns
            - Changes test infrastructure (conftest, fixtures)

            For MEDIUM-TO-CRITICAL changes:
            1. Create a PR with title: `fix: <description>`
            2. Add label `needs-review` to the PR
            3. Do NOT request reviewers manually — the auto-assign workflow handles it
            4. In the PR body, include:
               - `Closes #<issue-number>` (MUST be on its own line so GitHub auto-closes the issue on merge)
               - **Impact Assessment**: What parts of the system are affected
               - **Files Changed**: List with brief explanation of each change
               - **Test Results**: Full test output summary
               - **Risk Level**: Medium / High / Critical with reasoning
            5. Close the original issue with: `gh issue close <issue-number> -c "PR #<pr-number> created — needs review (@ashcastelinocs124)"`
            6. Do NOT merge. Wait for human approval.

            ## Project Conventions
            - Read aegis/CLAUDE.md for full project context
            - Commit messages: `fix(component):` or `feat(component):`
            - All models in aegis/backend/aegis/core/models.py
            - Async API / Sync agents — bridge with asyncio.to_thread
            - Mock side_effect overrides return_value — clear with mock.side_effect = None first
            - Patch notifier at source: aegis.services.notifier.notifier
